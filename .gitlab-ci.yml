stages:
  - build_staging
  - build_prod
  - deploy_staging
  - deploy_docker_staging
  - deploy_production

build_staging:
  stage: build_staging
  image: alpine:latest
  before_script:
    - "command -v ssh-agent >/dev/null || ( apk add --update openssh )"
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_WGS" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $VM_IPADDRESS_WGS >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh $SSH_USER_WGS@$VM_IPADDRESS_WGS "source \"/home/sandbox-dev/.sdkman/bin/sdkman-init.sh\" &&
      cd /home/sandbox-dev/staging/api &&
      git checkout staging && git pull && 
      sdk use java 8.0.352.fx-zulu &&
      sbt clean compile universal:packageBin &&
      docker login -u "${CI_REGISTRY_USER}" -p "${CI_REGISTRY_PASSWORD}" registry-v2.stagingapps.net &&
      docker build -t "${CI_REGISTRY_IMAGE}:latest" . &&
      docker tag "${CI_REGISTRY_IMAGE}:latest" "${CI_REGISTRY_IMAGE}:$CI_BUILD_REF" &&
      docker push "${CI_REGISTRY_IMAGE}:$CI_BUILD_REF" && exit"
  only:
    - staging
  tags:
    - new-shared

build_prod:
  stage: build_prod
  image: alpine:latest
  before_script:
    - "command -v ssh-agent >/dev/null || ( apk add --update openssh )"
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_WGS" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $VM_IPADDRESS_WGS >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh $SSH_USER_WGS@$VM_IPADDRESS_WGS "source \"/home/sandbox-dev/.sdkman/bin/sdkman-init.sh\" &&
      cd /home/sandbox-dev/prod/api &&
      git checkout prod-do && git pull && 
      sdk use java 8.0.352.fx-zulu &&
      sbt clean compile universal:packageBin &&
      docker login -u "${CI_REGISTRY_USER}" -p "${CI_REGISTRY_PASSWORD}" registry-v2.stagingapps.net &&
      docker build -t "${CI_REGISTRY_IMAGE_PROD}:latest" . &&
      docker tag "${CI_REGISTRY_IMAGE_PROD}:latest" "${CI_REGISTRY_IMAGE_PROD}:$CI_BUILD_REF" &&
      docker push "${CI_REGISTRY_IMAGE_PROD}:$CI_BUILD_REF" && exit"
  only:
    - prod-do
  tags:
    - new-shared

deploy_staging:
  image: registry.cn-hangzhou.aliyuncs.com/haoshuwei24/kubectl:1.16.6
  stage: deploy_staging
  environment:
    name: stg-sandbox-api
    url: https://${URL_STAGING}
  script:
    - kubectl version
    - cd manifest/
    - |
      if kubectl get secret | grep regcred; then
          echo "already exist"
          kubectl delete secret regcred
          kubectl create secret docker-registry regcred --docker-server=registry-v2.stagingapps.net --docker-username="${CI_REGISTRY_USER}" --docker-password="${CI_REGISTRY_PASSWORD}" || exit 1
      else
         kubectl create secret docker-registry regcred --docker-server=registry-v2.stagingapps.net --docker-username="${CI_REGISTRY_USER}" --docker-password="${CI_REGISTRY_PASSWORD}" || exit 1
      fi 
    - sed -i "s/__CI_ENVIRONMENT_SLUG__/${CI_ENVIRONMENT_SLUG}/" deployment.yaml service.yaml ingress.yaml
    - sed -i "s/__CI_PROJECT_NAME__/${CI_PROJECT_NAME}/" deployment.yaml service.yaml ingress.yaml pvc.yaml
    - sed -i "s/__URL_STAGING__/${URL_STAGING}/" ingress.yaml
    - sed -i "s,__IMAGE__:__VERSION__,${CI_REGISTRY_IMAGE}:$CI_BUILD_REF," deployment.yaml
    - kubectl apply -f pvc.yaml
    - kubectl apply -f deployment.yaml
    - kubectl apply -f service.yaml
    - kubectl apply -f ingress.yaml
    - kubectl rollout status -f deployment.yaml
    - kubectl get all,ing  -n "${KUBE_NAMESPACE}"
  only:
    - staging-k8s

deploy_docker_staging:
  stage: deploy_docker_staging
  script:
    - sed -i "s,_IMAGE:VERSION_,${CI_REGISTRY_IMAGE}:$CI_BUILD_REF," docker-compose.yml
    - scp docker-compose.yml ${USER_STG}@${HOST_STG}:~/app/sandbox-api/
    - ssh ${USER_STG}@${HOST_STG} docker login -u "${CI_REGISTRY_USER}" -p "${CI_REGISTRY_PASSWORD}" registry-v2.stagingapps.net
    - ssh ${USER_STG}@${HOST_STG} "cd ~/app/sandbox-api && docker compose up -d"
  only:
    - staging
  tags:
    - production

deploy_production:
  stage: deploy_production
  script:
    - sed -i "s,_IMAGE:VERSION_,${CI_REGISTRY_IMAGE_PROD}:$CI_BUILD_REF," docker-compose.yml
    - scp -P 222 docker-compose.yml deploy@188.166.206.252:~/api/
    - ssh -p 222 deploy@188.166.206.252 docker login -u "${CI_REGISTRY_USER}" -p "${CI_REGISTRY_PASSWORD}" registry-v2.stagingapps.net
    - ssh -p 222 deploy@188.166.206.252 "cd api && docker compose up -d"
  only:
    - prod-do
  tags:
    - production
